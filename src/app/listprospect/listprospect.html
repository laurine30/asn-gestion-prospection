<div class="prospection-container">
  <!-- TITRE CENTR√â -->
  <h2 class="title">Liste des Prospections</h2>

  <!-- BARRE DE RECHERCHE + BOUTON -->
  <div class="top-bar">
    <input 
      type="text" 
      placeholder=" Rechercher par client, type ou statut..." 
      [(ngModel)]="searchTerm" 
      (input)="applyFilter()"
    />
    <button class="btn-primary" (click)="createProspection()">
      <i class="fas fa-plus-circle"></i> Nouvelle Prospection
    </button>
  </div>

  <!-- TABLEAU DES PROSPECTIONS -->
  <table class="prospection-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Client</th>
        <th>Statut</th>
        <th>Montant (‚Ç¨)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let p of filteredProspections()">
        <td>{{ p.idProspection }}</td>
        <td>{{ p.nomClient || '-' }}</td>
        <td>
          <span class="statut-badge" [style.background]="getStatutColor(p.statut)">
            {{ p.statut }}
          </span>
        </td>
        <td>{{ p.montantEstime | number : '1.0-2' }}</td>
        <td class="actions">
          <button class="icon-btn edit" (click)="editProspection(p)" title="Modifier">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button class="icon-btn delete" (click)="confirmDelete(p)" title="Supprimer">
            <i class="bi bi-trash"></i>
          </button>
          <button class="icon-btn view" (click)="viewDetails(p)" title="D√©tails">
            <i class="bi bi-eye"></i>
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- üÜï MODAL D√âTAILS PROSPECTION -->
  <div *ngIf="showDetailsModal && prospectionToView" class="form-modal" (click)="closeDetailsModal()">
    <div class="details-card" (click)="$event.stopPropagation()">
      <button class="close-btn" (click)="closeDetailsModal()" type="button" title="Fermer">
        <i class="fas fa-times"></i>
      </button>

      <div class="form-header">
        <h1><i class="fas fa-info-circle" style="margin-right: 10px;"></i>D√©tails de la Prospection</h1>
      </div>

      <div class="details-content">
        <div class="detail-row">
          <span class="detail-label"><i class="fas fa-hashtag"></i> ID :</span>
          <span class="detail-value">{{ prospectionToView.idProspection }}</span>
        </div>

        <div class="detail-row">
          <span class="detail-label"><i class="fas fa-user"></i> Client :</span>
          <span class="detail-value">{{ prospectionToView.nomClient || '-' }}</span>
        </div>

        <div class="detail-row">
          <span class="detail-label"><i class="fas fa-briefcase"></i> Domaine :</span>
          <span class="detail-value">{{ prospectionToView.domaine }}</span>
        </div>

        <div class="detail-row">
          <span class="detail-label"><i class="fas fa-tag"></i> Type :</span>
          <span class="detail-value">{{ getTypeLabel(prospectionToView.type) }}</span>
        </div>

        <div class="detail-row">
          <span class="detail-label"><i class="fas fa-flag"></i> Statut :</span>
          <span class="detail-value">
            <span class="statut-badge" [style.background]="getStatutColor(prospectionToView.statut)">
              {{ prospectionToView.statut }}
            </span>
          </span>
        </div>

        <div class="detail-row">
          <span class="detail-label"><i class="fas fa-calendar"></i> Date de contact :</span>
          <span class="detail-value">{{ formatDate(prospectionToView.dateContact) }}</span>
        </div>

        <div class="detail-row">
          <span class="detail-label"><i class="fas fa-euro-sign"></i> Montant estim√© :</span>
          <span class="detail-value">{{ prospectionToView.montantEstime | number : '1.0-2' }} ‚Ç¨</span>
        </div>

        <div class="detail-row full-width">
          <span class="detail-label"><i class="fas fa-lightbulb"></i> Besoin identifi√© :</span>
          <p class="detail-description">{{ prospectionToView.besoin }}</p>
        </div>

        <div class="detail-row">
          <span class="detail-label"><i class="fas fa-calendar-plus"></i> Date de publication :</span>
          <span class="detail-value">{{ formatDate(prospectionToView.datePublication) }}</span>
        </div>

        <div class="detail-row">
          <span class="detail-label"><i class="fas fa-clock"></i> Derni√®re mise √† jour :</span>
          <span class="detail-value">{{ formatDate(prospectionToView.dateUpdate) }}</span>
        </div>

        <div class="detail-row">
          <span class="detail-label"><i class="fas fa-user-edit"></i> Modifi√© par :</span>
          <span class="detail-value">{{ prospectionToView.userUpdate || '-' }}</span>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-primary" (click)="closeDetailsModal()">
          <i class="fas fa-check"></i> Fermer
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL FORMULAIRE EN POPUP -->
  <div *ngIf="showForm" class="form-modal" (click)="closeModalOnBackdrop($event)">
    <div class="form-card" (click)="$event.stopPropagation()">
      <button class="close-btn" (click)="closeForm()" type="button" title="Fermer">
        <i class="fas fa-times"></i>
      </button>

      <div class="form-header">
        <h1>
          <i class="fas fa-bullseye" style="margin-right: 10px;"></i>
          {{ isEditMode ? 'Modifier la Prospection' : 'Nouvelle Prospection' }}
        </h1>
        <p>
          {{ isEditMode ? 
            'Mettez √† jour les informations de la prospection' : 
            'Enregistrez les informations d\'un nouveau prospect' 
          }}
        </p>
      </div>

      <div *ngIf="successMessage" class="success-message">
        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
        {{ successMessage }}
      </div>

      <div class="form-content">
        <form [formGroup]="form" (ngSubmit)="submit()">
          <!-- Section Client -->
          <div class="form-section">
            <h3><i class="fas fa-user" style="margin-right: 10px;"></i> Informations Client</h3>
            
            <div class="form-row">
              <div class="form-group">
                <label for="id_client">Client <span class="required">*</span></label>
                <select id="id_client" formControlName="id_client" [class.error]="hasError('id_client')">
                  <option [ngValue]="null">-- S√©lectionnez un client --</option>
                  <option *ngFor="let client of clients" [ngValue]="client.idClient">
                    {{ client.typeClient === 'PHYSIQUE' ? 
                      (client.nom + ' ' + client.prenom) : 
                      client.nomEntreprise 
                    }}
                    <span *ngIf="client.typeClient === 'PHYSIQUE'">(Particulier)</span>
                    <span *ngIf="client.typeClient === 'MORAL'">(Entreprise)</span>
                  </option>
                </select>
                <span class="error-message" *ngIf="hasError('id_client')">
                  <i class="fas fa-exclamation-circle"></i> Le client est obligatoire
                </span>
              </div>

              <div class="form-group">
                <label for="domaine">Domaine d'activit√© <span class="required">*</span></label>
                <input type="text" id="domaine" formControlName="domaine" 
                       placeholder="Ex: Tech, Finance, Sant√©..." 
                       [class.error]="hasError('domaine')"/>
                <span class="error-message" *ngIf="hasError('domaine')">
                  <i class="fas fa-exclamation-circle"></i> Le domaine d'activit√© est requis
                </span>
              </div>
            </div>
          </div>

          <!-- Section D√©tails -->
          <div class="form-section">
            <h3><i class="fas fa-chart-line" style="margin-right: 10px;"></i> D√©tails de la Prospection</h3>

            <div class="form-group">
              <label for="besoin">Besoin identifi√© <span class="required">*</span></label>
              <textarea id="besoin" formControlName="besoin" rows="4" 
                        placeholder="D√©crivez les besoins du client, les opportunit√©s identifi√©es..." 
                        [class.error]="hasError('besoin')"></textarea>
              <span class="error-message" *ngIf="hasError('besoin')">
                <i class="fas fa-exclamation-circle"></i> Le besoin doit contenir au moins 10 caract√®res
              </span>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="type">Type de prospection <span class="required">*</span></label>
                <select id="type" formControlName="type" [class.error]="hasError('type')">
                  <option [ngValue]="null">-- S√©lectionnez un type --</option>
                  <option *ngFor="let type of typesProspection" [ngValue]="type.value">
                    {{ type.label }}
                  </option>
                </select>
                <span class="error-message" *ngIf="hasError('type')">
                  <i class="fas fa-exclamation-circle"></i> Le type est requis
                </span>
              </div>

              <div class="form-group">
                <label for="statut">Statut <span class="required">*</span></label>
                <select id="statut" formControlName="statut">
                  <option *ngFor="let statut of statuts" [value]="statut.value">
                    {{ statut.label }}
                  </option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="dateContact">Date de contact <span class="required">*</span></label>
                <input type="date" id="dateContact" formControlName="dateContact" 
                       [class.error]="hasError('dateContact')"/>
                <span class="error-message" *ngIf="hasError('dateContact')">
                  <i class="fas fa-exclamation-circle"></i> La date de contact est requise
                </span>
              </div>

              <div class="form-group">
                <label for="montantEstime">Montant estim√© (‚Ç¨)</label>
                <input type="number" id="montantEstime" formControlName="montantEstime" 
                       placeholder="0" min="0" step="100"/>
                <small style="color: #718096; font-size: 0.85rem;">
                  <i class="fas fa-info-circle"></i> Laissez 0 si non d√©fini
                </small>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <button type="button" class="btn-secondary" (click)="closeForm()" [disabled]="isSubmitting">
              <i class="fas fa-times"></i> Annuler
            </button>
            <button type="submit" class="btn-primary" [disabled]="isSubmitting">
              <i class="fas" [class]="isEditMode ? 'fa-save' : 'fa-plus-circle'"></i>
              {{ isSubmitting ? 'En cours...' : (isEditMode ? 'Mettre √† jour' : 'Cr√©er la prospection') }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- MODAL SUPPRESSION -->
  <div class="delete-modal" *ngIf="showDeleteConfirm">
    <div class="delete-box">
      <div style="text-align: center; margin-bottom: 1.5rem;">
        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #e74c3c;"></i>
      </div>
      <h3>Confirmer la suppression ?</h3>
      <p>√ätes-vous s√ªr de vouloir supprimer cette prospection ? Cette action est irr√©versible.</p>
      <div class="delete-actions">
        <button class="btn-cancel" (click)="cancelDelete()">
          <i class="fas fa-times"></i> Annuler
        </button>
        <button class="btn-delete" (click)="deleteProspection()">
          <i class="fas fa-trash"></i> Supprimer d√©finitivement
        </button>
      </div>
    </div>
  </div>
</div>